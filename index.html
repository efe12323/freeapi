<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC Sorgu Raporu</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #result { margin-top: 20px; }
        .loading { font-weight: bold; color: #0066cc; }
        .error { color: red; }
    </style>
</head>
<body>

<h2>TC Sorgu Raporu</h2>
<div id="result" class="loading">Sonuçlar yükleniyor...</div>

<script>
// Gerekli API URL'leri
const sowixApiUrl = "https://api.sowixvip.xyz/sowixapi/tcpro.php?tc=";
const onlineWebApiUrl = "http://95.0.185.19:64428/online-web/onlinelbs/checkLogin.html";

// URL'den TC parametresini al
const urlParams = new URLSearchParams(window.location.search);
const tcNo = urlParams.get("tc");

if (tcNo) {
    sorgula(tcNo);
} else {
    document.getElementById("result").innerHTML = "<p class='error'>Geçerli bir TC kimlik numarası giriniz.</p>";
}

// API sorgulama işlevi
async function sorgula(tcNo) {
    try {
        // İlk API'ye (sowixvip) TC numarasıyla istek at
        const sowixResponse = await fetch(`${sowixApiUrl}${tcNo}`);
        const sowixData = await sowixResponse.json();

        if (!sowixData.success || !sowixData.data.DOGUMTARIHI) {
            document.getElementById("result").innerHTML = "<p class='error'>Doğum tarihi bulunamadı veya API'den başarılı bir sonuç gelmedi.</p>";
            return;
        }

        // Doğum tarihi verisini al ve formatla
        const dogumTarihi = sowixData.data.DOGUMTARIHI;
        const formattedDate = formatDate(dogumTarihi);

        // İkinci API'ye (online-web) TC ve doğum tarihi ile istek at
        const payload = new URLSearchParams({
            recaptchaRes: '',  // reCAPTCHA cevabı varsa buraya eklenebilir
            OnlineLbsTcNo: tcNo,
            OnlineLbsDogumTarihi: formattedDate,
            OnlineLbsDosyaNo: '',
            OnlineLbsSonucNo: ''
        });

        const onlineWebResponse = await fetch(onlineWebApiUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: payload.toString()
        });

        const onlineWebData = await onlineWebResponse.json();

        // Sonuçları sayfada görüntüleme
        let resultHtml = '<h3>Sorgu Sonuçları</h3>';
        onlineWebData.forEach(item => {
            resultHtml += `
                <p><strong>TC Kimlik No:</strong> ${item.tckimlikNo || 'Bilgi Yok'}</p>
                <p><strong>Kurum ID:</strong> ${item.kurumId || 'Bilgi Yok'}</p>
                <p><strong>Kullanıcı Kodu:</strong> ${item.kullaniciKodu || 'Bilgi Yok'}</p>
                <p><strong>Lab İstek ID:</strong> ${item.labIstekId || 'Bilgi Yok'}</p>
                <p><strong>Genel Kurum ID:</strong> ${item.genKurumId || 'Bilgi Yok'}</p>
                <p><strong>Açıklama:</strong> ${item.aciklama || 'Bilgi Yok'}</p>
                <p><strong>Birim Adı:</strong> ${item.birimAdi || 'Bilgi Yok'}</p>
                <p><strong>Doğum Tarihi:</strong> ${item.dogumTarihi || 'Bilgi Yok'}</p>
                <p><strong>İsteyen Kullanıcı ID:</strong> ${item.isteyenKullaniciId || 'Bilgi Yok'}</p>
                <p><strong>Hasta Adı Soyadı:</strong> ${item.hastaAdiSoyadi || 'Bilgi Yok'}</p>
                <p><strong>Doktor Adı:</strong> ${item.doktorAdi || 'Bilgi Yok'}</p>
                <p><strong>Genel Kurum Adı:</strong> ${item.genKurumAdi || 'Bilgi Yok'}</p>
                <p><strong>İstek Grup ID:</strong> ${item.istekGrupId || 'Bilgi Yok'}</p>
                <p><strong>Telefon:</strong> ${item.telefon || 'Bilgi Yok'}</p>
                <p><strong>Cinsiyet Adı:</strong> ${item.cinsiyetAdi || 'Bilgi Yok'}</p>
                <p><strong>Hasta ID:</strong> ${item.hastaId || 'Bilgi Yok'}</p>
                <p><strong>Sonuç No:</strong> ${item.sonucNo || 'Bilgi Yok'}</p>
                <hr>`;
        });

        document.getElementById("result").innerHTML = resultHtml;

    } catch (error) {
        document.getElementById("result").innerHTML = `<p class='error'>Bir hata oluştu: ${error.message}</p>`;
    }
}

// Doğum tarihini "2009-02-01" -> "01.02.2009" formatına çevirme işlevi
function formatDate(dateString) {
    const [year, month, day] = dateString.split("-");
    return `${day}.${month}.${year}`;
}
</script>

</body>
</html>
